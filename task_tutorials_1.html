<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Blockly for EUP</title>

  <link rel="stylesheet" href="https://code.getmdl.io/1.2.1/material.indigo-pink.min.css">
  <link rel="stylesheet" href="styles/task2.css">
  <link rel="stylesheet" href="styles/general.css">
  <script src="interpreter/acorn_interpreter.js"></script>
</head>
<body>

  <div>
      <div id='tutorial_text' style="display:inline-block;width: 60%; font: 20px Arial, sans-serif; margin-left: 120px; margin-top: 20px; float: center;">
        Welcome to the Robot Programming Tutorial! The goal of this tutorial is to familiarize you with the robot programming interface, so you can start creating custom behaviors for robotic tasks. Let's get started! <br/><b>Once you have completed each step, click on the <i>"Next"</i> button located at the bottom right to proceed with the tutorial.</b>
      </div>

    <div id='img_div' style="height: 50%; display:inline-block; margin-left: -500px; margin-top:20px;"></div>
  </div>

  <div class="wrapper">

    <div id="modal" class="modal">

      <!-- Modal content -->
      <!-- <div class="modal-content">
        <div class="modal-header">
          <h2>Thank you for completing the study</h2>
        </div>
        <div class="modal-body">
          <p>Please return to Qualtrics and enter the following code: <mark>61948336</mark></p>
          <p>Note that once you click exit, this window will close, and you will not be able to access the code again</p>
        </div>
        <button onclick="window.close()">
          Exit
        </button>
      </div> -->

    <p style="display: none;", id="code"></p>
    <p style="display: none;", id="start"></p>
    <p style="display: none;", id="end"></p>
    
    </div>

    <p id="code"></p>

    <div class="simulation">
        <div id="bedroom">
        <p id="room-txt"> bedroom </p>
      </div>
        <div id="kitchen">
        <p id="room-txt"> kitchen</p>
      </div>
        <div id="playroom">
          <p id="room-txt"> playroom</p>
      </div>

      <div id="robot">
        <img id="robot-img" src="assets/robot.png">
      </div>
      <div id="bear" style="visibility: hidden;">
        <img id="toy-img" src="assets/toy1.png">
      </div>
    </div>


    <div class="blockly-editor">
      <div id="controls">
        <!-- <div id="clock"> -->

        <!-- </div> -->
      <button class="run" id="runButton" onclick="toggleButton()" title="Makes the player do what the blocks say.">Run Program</button>
        <button id="doneButton" style="visibility: hidden;">I'm Done</button>
    </div>
      <div id="blocklyDiv">
      <xml id="toolbox" style="display: none;">
        <category name="Controls" style="display: none;" categorystyle="logic_category">
          <block type="if_then"></block>
          <block type="if_while_then"></block>
      </category>
      <category name="Actions" categorystyle="variable_category">
        <block type="drop_toy"></block>
        <block type="pick_up_toy"></block>
        <block type="to_room"></block>
        <block type="to_random_room"></block>
      </category>
      <category name="Events" categorystyle="list_category">
        <block type="out_of"></block>
        <block type="in_the"></block>
        <block type="hands_free"></block>
        <block type="hands_full"></block>
        <block type="start"></block>
      </category>
      <category name="States" categorystyle="event_category">
        <block type="e_out_of"></block>
        <block type="e_in_the"></block>
        <block type="e_toy_in_room"></block>
        <block type="e_toy_not_in_room"></block>
        <block type="e_hands_free"></block>
        <block type="e_hands_full"></block>
        <block type="and"></block>
      </category>
      <category name="Actions" categorystyle="variable_category">
        <block type="drop_toy"></block>
        <block type="pick_up_toy"></block>
        <block type="to_room"></block>
        <block type="to_random_room"></block>
      </category>
      <category name="Goal" categorystyle="event_category">
        <block type="e_out_of"></block>
        <block type="e_toy_in_room"></block>
        <block type="e_in_the"></block>
        <block type="e_toy_not_in_room"></block>
        <block type="e_hands_free"></block>
        <block type="e_hands_full"></block>
        <block type="and"></block>
      </category>
      <category name="States" categorystyle="logic_category">
        <block type="trigger_out_of"></block>
        <block type="trigger_in_the"></block>
        <block type="trigger_hands_full"></block>
        <block type="trigger_hands_free"></block>
      </category>
      <category name="Controls" style="display: none;" categorystyle="logic_category">
        <block type="controls_if"></block>
        <block type="controls_ifelse"></block>
        <block type="logic_boolean"></block>
        <block type="controls_whileUntil"></block>
    </category>
      </xml>
    </div>
  </div>
  </div>

  <div id="tutorial_controls" style="float: right; margin-right: 240px; margin-top:-60px">
      <button id="nextButton"  title="Next tutorial" onclick="nextTutorialListener()">
      Next
      </button>
    </div>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.8.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.8.2/firebase-analytics.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.8.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "%API_KEY%",
      authDomain: "eup-blockly.firebaseapp.com",
      projectId: "eup-blockly",
      storageBucket: "eup-blockly.appspot.com",
      messagingSenderId: "217753483766",
      appId: "%APP_ID%",
      measurementId: "G-9CXK0MCT41",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);

    // Initialize Cloud Firestore and get a reference to the service
    const db = getFirestore(app);

    console.log(window.location.href);
    const url = new URL(window.location.href);
    // console.log(url.searchParams.get('STUDY_ID'));

    // document.querySelector("#runButton").addEventListener("click", record);
    document.querySelector("#doneButton").addEventListener("click", finalRecord);

    async function record(){
        try {
          const timeElapsed = Date.now();
          const today = new Date(timeElapsed);
          const docRef = await addDoc(collection(db, "task_tutorial"), {
            study_id: url.searchParams.get('STUDY_ID'),
            prolific_pid: url.searchParams.get('PROLIFIC_PID'),
            session_id: url.searchParams.get('SESSION_ID'),
            timestamp: today.toISOString(),
            code: document.getElementById("code").innerHTML
          });
          console.log("Document written with ID: ", docRef.id);
        } catch (e) {
          console.error("Error adding document: ", e);
        }
    }
  </script>

  <script src="https://unpkg.com/blockly"></script>
  <script src="scripts/obj.js"></script>
  <script src="scripts/game.js"></script>
  <script id="tap" src="scripts/tap_blocks.js"></script>
  <script id="rl" src="scripts/rl_blocks.js"></script>
  <script src="scripts/settings/task_tutorial.js"></script>
  <script src="scripts/run.js"></script>
  <script src="scripts/mdp.js"></script>
  <script src="scripts/rl.js"></script>
  
<!--   <script src="https://unpkg.com/blockly"></script>
  <script src="scripts/obj.js"></script>
  <script src="scripts/game.js"></script>
  <script id="tap" src="scripts/tap_blocks.js"></script>
  <script id="rl" src="scripts/rl_blocks.js"></script>
  <script src="scripts/settings/"></script>
  <script src="scripts/run.js"></script> -->

  <script type="text/javascript">
    var next_ctr = 0;

    const params = new Proxy(new URLSearchParams(window.location.search), {
      get: (searchParams, prop) => searchParams.get(prop),
    });
    let value = params.format;


    var tutorial_texts = ["To begin, let's take a look at the environment our robot will be operating in. The interface on the left displays a visual representation of three rooms: the bedroom, kitchen, and playroom. This is where our robot will be navigating and performing its tasks.",
     "The right half of the interface is where you program the robot.",
     "The robot is designed to sense and react based on the rules you provide in the programming interface.",
     "Now, let's attempt to move the robot from the bedroom to the kitchen. To do this, <ol> <li> click on the \"Controls\" tab and drag the piece labeled \"If then\" and attach it to the \"Rules\" block found in the programming interface.</li> <li> Next, click on the \"Events\" tab and drag the piece labeled \"program started\" and attach it to the \"If then\" block in the Rules block.</li> <li> Next, from the \"Actions\" tab, drag the \"Go to <b>kitchen</b>\" piece and attach it to the \"If program starts\" piece. This will create a sequence of actions that will guide the robot from the bedroom to the kitchen. </li></ol>",
     "If your program looks like the image on the right,<br> then press the \"Run Program\" button to see your program running.", 
     "Now let's work on a second task. In this task you will program the robot to move the toy from the playroom to the kitchen. To do this, <ol> <li>First remove the \"Go to kitchen\" piece added to the \"Rules\" block by dragging it to the trash found on the bottom right corner</li><li> Next, from the \"Actions\" tab, drag the \"Go to <b>kitchen</b>\" piece and attach it to the \"If program starts block\" piece. Change the room from kitchen to <b>playroom</b> by choosing from the drop down menu on the piece you just attached.</li></ol>",
      "The next step is for the robot to pick up the toy once it gets to the playroom. <ol><li> The robot first checks if it has reached the playroom before it tries to pick up the toy. To do that, click on the Controls tab and drag the \"if and then\" piece and attach it to the Rules below the \"If program starts\" block.</li>\
      <li>Then the robot checks if it successfully picked up the toy before it moves to the kitchen. Click on the Controls tab and drag the \"if and then\" piece and attach it to the Rules below the last two blocks. Then from the Events tab drag \"My hands became full\" attach it to the new \"if and then\" piece.</li>\
      <li>Click on the Actions tab and drag the \"go to the kitchen\" action. and place inside the if block. This will finalize the action to be performed once the toy is picked up.</li>\
      <li>Once the robot gets to the kitchen it needs to put down the toy. For that we drag the \"if then\" block and check \"I have arrived at the <kitchen>\" condition and add the \"put down the toy\" action.</li>\</ol>",
     "If your progarm looks like the image on the right, <br> then press the \"Run Program\" button to see your program running."
    ];

    var tutorial_texts_RL = ["The robot is designed to act based on a <b>goal</b> specified to it. In addition to the goal, the robot requires the user to specify all the possible <b>states</b> it can be in such as \"I am holding a toy.\", \"I am in the kitchen.\" etc. It also requires knowing all the possible states to achieve its goal. Finally,  the robot must be informed of the set of <b>actions</b> it needs to use to complete the task. Once these are provided to it, the robot tries to find an optimal behavior towards accomplishing the task.",
      "Now, let's attempt to move the robot to the kitchen. To achieve this, <ol><li>First, we need to specify is the goal. To do that click on the \"Goal\" tab and drag \"I am in the kitchen\" piece and attach it to the \"Goal\" piece in the programming interface.</li> <li>Next, we need to specify the action. Click on the \"Actions\" tab and drag the \"Go to kitchen\" piece and attach it to \"Actions\" on the programming interface. </li> <li>Finally, we need to tell the robot all of the states it can be in while trying to get to the kitchen. </li> <li>Click on the \"States\" tab and drag the \"Am I in the kitchen?\" piece and attach it to \"States\" on the programming interface.</li> </ol>", "If your program looks like the image on the right,<br> then press the \"Run Program\" button to see your program running.", "Now let's work on a second task. In this task you will program the robot to move the toy from the playroom to the kitchen.", "To do this, <ol> <li>First remove the \"Am I in the kitchen?\" piece added to the \"Goal\" block by dragging it to the trash found on the bottom right corner</li><li>To successfully perform the task, the robot needs to have a set of actions: going to the kitchen, going to the playroom, picking up the toy, and putting down the toy. Therefore, drag the \"Go to kitchen\" from the actions tab and attach it to the actions block. Add the \"Go to playroom\", \"pick up the toy\", and \"put down the toy\" to the actions block below the previous piece</li>, <li>Next, let's specify the states the robot could be in while trying to complete the task. These states are being in the kitchen, being in the playroom, and holding the toy. Drag the pieces that represent each state and attach them to the states block.</li> <li>Finally, we specify the goal. The robot can only know it has achieved the goal by sensing the environment. For the current task, the goal can be stated as the robot seeing the toy in the kitchen. To specify this, drag the \"and\" piece from the Goal tab and attach it to the Goal piece. Then drag \"Am I in the kitchen?\" piece from the Goal tab and attach it to one of the empty spaces in the \"and\" piece. Then, drag \"a toy is in the room\" piece and attach it to the remaining space of the \"and\" piece </li>", "If your progarm looks like the image on the right, <br> then press the \"Run Program\" button to see your program running."
    ];

    var tutorial_texts_MDP = ["The robot is designed to act based on a <b>goal</b> specified to it. Once the goal is provided to it, the robot tries to find an optimal behavior towards accomplishing the task.",
      "Now, let's attempt to move the robot to the kitchen. To achieve this, we need to specify is the goal. To do that click on the \"Goal\" tab and drag \"I am in the kitchen\" piece and attach it to the \"Goal\" piece in the programming interface.", "If your program looks like the image on the right,<br> then press the \"Run Program\" button to see your program running.", "Now let's work on a second task. In this task you will program the robot to move the toy from the playroom to the kitchen.", "To do this, <ol> <li>First remove the \"Am I in the kitchen?\" piece added to the \"Goal\" block by dragging it to the trash found on the bottom right corner</li><li>To successfully perform the task, the robot needs a specification of the goal. The robot can only know it has achieved the goal by sensing the environment. For the current task, the goal can be stated as the robot seeing the toy in the kitchen. To specify this, drag the \"and\" piece from the Goal tab and attach it to the Goal piece. Then drag \"Am I in the kitchen?\" piece from the Goal tab and attach it to one of the empty spaces in the \"and\" piece. Then, drag \"a toy is in the room\" piece and attach it to the remaining space of the \"and\" piece </li>", "If your progarm looks like the image on the right, <br> then press the \"Run Program\" button to see your program running."
    ];

    var tutorial_texts_SEQ = ["The robot is designed to follow actions specified by users. These sequences of actions are specified in the programming interface by dragging and dropping actions. The robot also has sensors to sense where it is and if it is holding objects.", "Now, let's attempt to move the robot to the kitchen. To achieve this, Click on the \"Actions\" tab and drag \"Go to kitchen\" piece and drop it on the programming interface.", "If your program looks like the image on the right,<br> then press the \"Run Program\" button to see your program running.", "Now let's work on a second task. In this task you will program the robot to move the toy from the playroom to the kitchen. To do this, <ol><li>First remove the \"Go to kitchen\" piece added to the programming interface by dragging it to the trash found on the bottom right corner</li> <li>Then click on the <b>Actions</b> tab and drag the \"Go to kitchen\" piece and change kitchen to playroom</li><li>After getting to the playroom, the robot needs to pick up the toy. Before trying to pick up the toy, we will first make the robot check if there is a toy. For that, click on the Controls tab and drag the \"If do\" block and attach it under the \"Go to playroom\" piece. Then drag \"a toy is in the room\" piece from the states tab and attach it to the if.</li><li>click on the <b>actions</b> menu and drag the \"Pick up the toy\" piece and attach it next to <b>do</b>. </li> <li>Once the robot picks up the toy, the next step is to take the toy to the kitchen. Drag \"Go to kitchen\" piece and attach it below the \"if do\" block.</li><li>The final step is to put down the toy. For that click on the <b>actions</b> menu and drag the \"put down the toy\" piece and place it below the last piece.</li></ol>", "If your program looks like the image on the right,<br> then press the \"Run Program\" button to see your program running."]

    function nextTutorialListener(){
      if(value=="TAP"){
        document.getElementById('tutorial_text').innerHTML = tutorial_texts[next_ctr];

        if(next_ctr == 4){
          var elem = document.createElement("img");
          elem.src = 'tutorial/sol_01.png';
          document.getElementById('img_div').appendChild(elem);
        }

        else if(next_ctr == 5){
            document.getElementById("img_div").innerHTML = '';
            document.getElementById('bear').style.visibility = 'visible';
        }

        else if(next_ctr == 7){
            var elem = document.createElement("img");
            elem.src = 'tutorial/sol_02.png';
            document.getElementById('img_div').appendChild(elem);
        }

        if (next_ctr >= tutorial_texts.length){
            document.getElementById("img_div").innerHTML = '';
            document.getElementById('doneButton').style.visibility = 'visible';
            document.getElementById('tutorial_text').innerHTML = "Congratulations on completing the tutorial tasks! <br/>Please copy the code <b>TD4823</b> and paste it into the survey to proceed with the next set of tasks.";
          }
      }
      else if(value=='RL'){
        if(next_ctr < 2){
          document.getElementById('tutorial_text').innerHTML = tutorial_texts[next_ctr];
        }else{
          document.getElementById('tutorial_text').innerHTML = tutorial_texts_RL[next_ctr-2];
        }
        if(next_ctr == 4){
          var elem = document.createElement("img");
          elem.src = 'tutorial/sol_05.png';
          document.getElementById('img_div').appendChild(elem);
        }
        else if(next_ctr == 5){
            document.getElementById("img_div").innerHTML = '';
            document.getElementById('bear').style.visibility = 'visible';
        }else if(next_ctr == 7){
            var elem = document.createElement("img");
            elem.src = 'tutorial/sol_06.png';
            document.getElementById('img_div').appendChild(elem);
        }

        if (next_ctr - 2 >= tutorial_texts_RL.length){
            document.getElementById("img_div").innerHTML = '';
            document.getElementById('doneButton').style.visibility = 'visible';
            document.getElementById('tutorial_text').innerHTML = "Congratulations on completing the tutorial tasks! Please copy the code <b>TD4823</b> and paste it into the survey to proceed with the next set of tasks."
       } 
        
      }
      else if(value=='MDP'){
        if(next_ctr < 2){
          document.getElementById('tutorial_text').innerHTML = tutorial_texts[next_ctr];
        }else{
          document.getElementById('tutorial_text').innerHTML = tutorial_texts_MDP[next_ctr-2];
        }
        if(next_ctr == 4){
          var elem = document.createElement("img");
          elem.src = 'tutorial/sol_07.png';
          document.getElementById('img_div').appendChild(elem);
        }
        else if(next_ctr == 5){
            document.getElementById("img_div").innerHTML = '';
            document.getElementById('bear').style.visibility = 'visible';
        }else if(next_ctr == 7){
            var elem = document.createElement("img");
            elem.src = 'tutorial/sol_08.png';
            document.getElementById('img_div').appendChild(elem);
        }

        if (next_ctr - 2 >= tutorial_texts_RL.length){
            document.getElementById("img_div").innerHTML = '';
            document.getElementById('doneButton').style.visibility = 'visible';
            document.getElementById('tutorial_text').innerHTML = "Congratulations on completing the tutorial tasks! Please copy the code <b>TD4823</b> and paste it into the survey to proceed with the next set of tasks."
       }

     }
      else if (value == 'SEQ'){
         if(next_ctr < 2){
          document.getElementById('tutorial_text').innerHTML = tutorial_texts[next_ctr];
          }else{
            document.getElementById('tutorial_text').innerHTML = tutorial_texts_SEQ[next_ctr-2];
          }

          if(next_ctr == 4){
            var elem = document.createElement("img");
            elem.src = 'tutorial/sol_03.png';
            document.getElementById('img_div').appendChild(elem);
          }else if(next_ctr == 5){
            document.getElementById("img_div").innerHTML = '';
            document.getElementById('bear').style.visibility = 'visible';
          }
          else if(next_ctr == 6){
            var elem = document.createElement("img");
            elem.src = 'tutorial/sol_04.png';
            document.getElementById('img_div').appendChild(elem);
          }

          if (next_ctr - 2 >= tutorial_texts_SEQ.length){
            document.getElementById("img_div").innerHTML = '';
            document.getElementById('doneButton').style.visibility = 'visible';
            document.getElementById('tutorial_text').innerHTML = "Congratulations on completing the tutorial tasks! Please copy the code <b>TD4823</b> and paste it into the survey to proceed with the next set of tasks."
          }

      }      

      next_ctr+=1;
    }

  </script>

</body>
</html>
