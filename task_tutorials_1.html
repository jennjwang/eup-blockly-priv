<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Blockly for EUP</title>

    <link
      rel="stylesheet"
      href="https://code.getmdl.io/1.2.1/material.indigo-pink.min.css"
    />
    <link rel="stylesheet" href="styles/tutorial.css" />
    <link rel="stylesheet" href="styles/general.css" />
    <script src="interpreter/acorn_interpreter.js"></script>
  </head>
  <body>
    <div
      id="tutorial_controls"
      style="position: absolute; margin-left: 84%; margin-top: 2%"
    >
      <button
        id="nextButton"
        title="Next tutorial"
        onclick="nextTutorialListener(0)"
      >
        Next</button
      ><br /><br /><br />
      <button
        id="backButton"
        title="Back tutorial"
        onclick="nextTutorialListener(1)"
      >
        Back
      </button>
    </div>
    <div
      id="one_time_div"
      style="position: absolute; margin-top: 3%; margin-left: 55%; float: right"
    ></div>
    <div
      id="img_div"
      style="position: absolute; margin-top: 2%; margin-left: 52%; float: right"
    ></div>
    <div
      id="tutorial_text"
      style="
        position: absolute;
        display: inline-block;
        width: 40%;
        line-height: normal;
        font-size: 1vw;
        font-family: Arial, sans-serif;
        margin-left: 6%;
        margin-top: 3%;
        float: left;
      "
    >
      The goal of this part of the tutorial is to familiarize you with the robot
      programming interface so you can start creating custom behaviors for
      robotic tasks. Let's get started!
      <br /><br /><b>
        Once you have completed each step, click on the <i>"Next"</i> button
        located at the top right to proceed with the tutorial.</b
      >
    </div>

    <div class="wrapper">
      <div id="modal" class="modal">
        <!-- Modal content -->
        <div class="modal-content">
          <div class="modal-header">
            <h3>You’ve completed the tutorial</h3>
          </div>
          <div class="modal-body">
            <p>
              Please return to the survey and enter the following code:
              <mark>TDdnqwn</mark>
            </p>
            <!-- <p>Note that once you click exit, this window will close, and you will not be able to access the code again</p> -->
          </div>
          <!--         <button onclick="window.close()">
          Exit
        </button> -->
        </div>

        <p style="display: none" , id="code"></p>
        <p style="display: none" , id="start"></p>
        <p style="display: none" , id="end"></p>
      </div>

      <p id="code"></p>

      <div class="simulation">
        <div id="porch">
          <p id="room-txt">porch</p>
          <img id="porch-img" src="assets/porch-img.webp" />
        </div>
        <div id="bedroom">
          <p id="room-txt">bedroom</p>
          <img id="bedroom-img" src="assets/carp2.jpeg" />
        </div>
        <div id="kitchen">
          <p id="room-txt">kitchen</p>
          <img id="kitchen-img" src="assets/tiles.webp" />
        </div>
        <div id="playroom">
          <p id="room-txt">playroom</p>
          <img id="playroom-img" src="assets/wood.jpeg" />
        </div>

        <div id="robot">
          <img id="robot-img" src="assets/robot.png" />
        </div>
        <div id="mail" style="visibility: hidden">
          <img id="mail-img" src="assets/mail.png" />
        </div>
        <div id="coffee" style="visibility: hidden">
          <img id="coffee-img" src="assets/coffee.png" />
        </div>
        <div id="bear" style="visibility: hidden">
          <img id="toy-img" src="assets/toy1.png" />
        </div>
      </div>

      <div class="blockly-editor">
        <div id="controls">
          <!-- <div id="clock"> -->

          <!-- </div> -->
          <button
            class="run"
            id="runButton"
            onclick="toggleButton()"
            title="Makes the player do what the blocks say."
          >
            Run Program
          </button>
          <button id="doneButton" style="visibility: hidden">I'm Done</button>
        </div>
        <div id="blocklyDiv">
          <xml id="toolbox" style="display: none">
            <category
              name="Controls"
              style="display: none"
              categorystyle="logic_category"
            >
              <block type="if_then"></block>
              <block type="if_while_then"></block>
            </category>
            <category name="Actions" categorystyle="variable_category">
              <block type="pick_up_coffee_mail"></block>
              <block type="drop_coffee_mail"></block>
              <block type="to_room"></block>
              <block type="to_random_room"></block>
            </category>
            <category name="Events" categorystyle="list_category">
              <block type="out_of"></block>
              <block type="in_the"></block>
              <block type="person_in_room"></block>
              <block type="start"></block>
              <block type="hands_free"></block>
              <block type="hands_full"></block>
            </category>
            <category name="States" categorystyle="event_category">
              <block type="e_out_of"></block>
              <block type="e_in_the"></block>
              <block type="e_hands_free"></block>
              <block type="e_hands_full"></block>
              <block type="e_thing_in_room"></block>
              <block type="e_thing_not_in_room"></block>
              <block type="and"></block>
            </category>
            <category name="Actions" categorystyle="variable_category">
              <block type="pick_up_coffee_mail"></block>
              <block type="drop_coffee_mail"></block>
              <block type="to_room"></block>
              <block type="to_random_room"></block>
            </category>
            <category name="Goal" categorystyle="event_category">
              <block type="e_out_of"></block>
              <block type="e_in_the"></block>
              <block type="e_hands_free"></block>
              <block type="e_hands_full"></block>
              <block type="e_thing_in_room"></block>
              <block type="e_thing_not_in_room"></block>
              <block type="and"></block>
            </category>
            <category name="States" categorystyle="logic_category">
              <!-- <block type="trigger_out_of"></block> -->
              <block type="trigger_in_the"></block>
              <block type="trigger_hands_free"></block>
              <!-- <block type="trigger_hands_full"></block> -->
              <block type="trigger_thing_in_room"></block>
            </category>
            <category
              name="Controls"
              style="display: none"
              categorystyle="logic_category"
            >
              <block type="controls_if"></block>
              <block type="controls_ifelse"></block>
              <block type="logic_boolean"></block>
              <block type="controls_whileUntil"></block>
            </category>
          </xml>
        </div>
      </div>
    </div>

    <script type="module"></script>

    <script src="scripts/blockly.min.js"></script>
    <script src="scripts/obj.js"></script>
    <script src="scripts/game.js"></script>
    <script id="tap" src="scripts/tap_blocks.js"></script>
    <script id="rl" src="scripts/rl_blocks.js"></script>
    <script src="scripts/settings/task_tutorial.js"></script>
    <script src="scripts/run.js"></script>
    <script src="scripts/mdp.js"></script>
    <script src="scripts/rl.js"></script>

    <!--   <script src="https://unpkg.com/blockly"></script>
  <script src="scripts/obj.js"></script>
  <script src="scripts/game.js"></script>
  <script id="tap" src="scripts/tap_blocks.js"></script>
  <script id="rl" src="scripts/rl_blocks.js"></script>
  <script src="scripts/settings/"></script>
  <script src="scripts/run.js"></script> -->

    <script type="text/javascript">
      var next_ctr = 0;
      var img_added = false;

      const params = new Proxy(new URLSearchParams(window.location.search), {
        get: (searchParams, prop) => searchParams.get(prop),
      });
      let value = params.format;

      var tutorial_texts = [
        "<div style='width:180%'>To begin, let's take a look at the environment our robot will be operating in. The interface on the left displays a visual representation of four rooms in a house: the bedroom, kitchen, porch, and playroom. This is where the robot will be navigating and performing its tasks.<br><br> Click <b>Next</b> to proceed.</div>",
        "<div style='width:180%'>The right half of the interface is where you can program the robot. <br><br> Click <b>Next</b> to proceed.</div>",
        "<div style='width:180%'>The robot is designed to act based on a set of rules you provide in the programming interface. Rules consist of TRIGGERS, ACTIONS, and may optionally include STATES. <br><br> For each of the rules you create, you need to specify a <b>TRIGGER, an event that, once it occurs, allows the robot to respond (for example, arriving to the kitchen or its hands becoming full by picking up a toy).<br><br>Click <b>Next</b> to proceed.</div>",
        "<div style='width:180%'>In addition to triggers, the robot requires you to specify ACTIONS it needs to perform following the activation of triggers (for example, pick up a toy, move to the kitchen). <br><br>Optionally, you may specify STATES or conditions that a robot may need to evaluate before executing an action within a rule. For example, to know whether or not to pick up a toy (action), the robot needs to know whether it is already holding a toy (state). <br><br> Click <b>Next</b> to proceed.</div>",
        "<div style='width:180%'>Once all the rules are provided to it, the robot executes actions based on these rules towards accomplishing a task. <br><br> Click <b>Next</b> to proceed.</div>",
        '<div style=\'width:180%\'>Now, you will construct a program to make the robot take a toy from the kitchen to the playroom. At the start the robot might be in any one of the four rooms. Therefore, you need to specify a rule for the robot to go to the kitchen as soon as the program starts. To achieve this, click on the "Controls" tab and drag the piece labeled "if then" and attach it to the "Rules" block found in the programming interface. This block will create the “IF statement and a THEN statement” structure of the first rule. <br><br> Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>Next, click on the "Events" tab and drag the piece labeled "program started" and attach it to the if in the "if then" piece in "Rules". The “program started” piece is a trigger that activates only once when the program you constructed starts. <br><br> Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>Next, from the "Actions" tab, drag the "Go to kitchen" piece and attach it to the "if program started" piece. <br><br> The rule you just created instructs the robot to move to the kitchen when the program starts.  <br><br> Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>Once the robot arrives in the kitchen, it needs to pick up the toy. Before trying to pick up the toy, you will program the robot to check if there is a toy. While this check may seem unnecessary, since we know that the toy will be in the kitchen, in other cases, the robot may not know where the toy is ahead of time, which makes performing this check to see if the toy is in the room helpful. To accomplish this, you need the “<b>if and then</b>” rule. Click on the "Controls" tab and drag the "if and then" piece and attach it to the "Rules" block below the previous rule.<br> <br>Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>You will need to have the robot detect the arriving to the kitchen event before it tries to pick up the toy. Now drag the "I arrived at the kitchen" piece from the "Events" tab and attach it next to if. Then, click on the "States" tab and drag "there is a toy in the room" and attach it next to and. This block would help the robot check if there is a toy in the kitchen as soon as it arrives in the room.  Once the robot arrives at the kitchen and there is a toy in the room, the robot will now need to pick up the toy. For that, drag the "pick up the toy" piece from actions and attach it next to <b>then</b>.<br> <br>Click <b>Next</b> to proceed. </div>',
        '<div style=\'width:180%\'>Now that you have enabled the robot to pick up the toy at the kitchen, you’ll need to program the robot to go to the kitchen after having picked up the toy. To do this, we’ll rely on the event “I picked up an item” to instruct the robot to then head to the playroom. To do this, click on the "Controls" tab and drag the "if then" piece and attach it to the "Rules" below the last two blocks. Then, from the "Events" tab drag "I picked up an item" and attach it to the new "if then" piece. This piece helps the robot detect if it just picked up something.<br> <br>Click <b>Next</b> to proceed. </div>',
        '<div style=\'width:180%\'>Click on the "Actions" tab and drag the "go to the kitchen" piece inside the newly added "if then" block. Change the room from kitchen to <b>playroom</b> by clicking on the caret (downward pointing triangle) of the piece you just attached. This will allow the robot to move to the playroom once it has picked up the toy. <br> <br>Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>Next you will need to program the robot to put down the toy as soon as it gets to the playroom. To do that, drag the "if and then" block and attach it below the last block. Then you should add a way to detect if the robot arrives at the playroom: "I have arrived at the playroom." Add the piece "put down the item" as the action.<br> <br>Click <b>Next</b> to proceed. </div>',
        'If your program looks like the image on the right, then press the "Run Program" button to see your program running. Otherwise, move the blocks around to make them match the image and then run the program. <br><br>If the robot remains inactive after you click "Run Program," double check that your program is correct. Click "Stop Program" to make any needed changes and then rerun the program.<br> <br>Click <b>Next</b> to proceed.',
        "<div style='width:180%'>Note that, in this first example program, each rule triggered based off of another rule’s action completing (or the start of the program). This does not always need to be the case. Sometimes, rules should trigger based off of changes to the environment that the robot observes. For each task, you will need to consider what triggers make the most sense. However, this strategy of having other rules trigger based on another rule’s action completion is the most straightforward way to have the robot complete a sequence of actions since each rule can only contain one action.</div>",
        "<div style='width:180%'>Now let's work on the final task. In this task, both a cup of coffee and a piece of mail will start on the porch, and your objective is to program a robot to move the coffee and mail from the porch to the kitchen. However, because the coffee is likely to get cold if outside too long, the robot should first move the coffee to the kitchen and then come back to move the mail to the kitchen. The robot should take the coffee to the kitchen and then the mail to the kitchen in this order. <br><br> Click <b>Next</b> to proceed.</div>",
        "<div style='width:180%'>First remove all the pieces added to the \"Rules\" block by dragging them to the trash bin found on the bottom right corner.<br><br> Click <b>Next</b> to proceed.</div>",
        '<div style=\'width:180%\'>To have the robot perform the task, you’ll first need the robot to go to the porch. From the "Actions" tab, drag the "Go to kitchen" piece and attach it to the piece "If program started." Change the room from kitchen to porch by clicking on the caret (downward pointing triangle) of the piece you just attached. This will ensure that the robot will go to the porch once the program begins. <br><br>Note that the "go to porch" piece is the same as the "go to kitchen" piece (click on the caret to change the room name). <br><br> Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>Next, you need to program the robot to pick up the coffee once it gets to the playroom. <br>For this second rule, you will need to have the robot detect the arriving to the porch event before it tries to pick up the coffee. To ensure that the robot executes each action appropriately, it is necessary to incorporate rules like these for every desired action. This is because the robot is designed to carry out actions only when it detects events being triggered. Click on the "Controls" tab and drag the "<b>if and then</b>" piece and attach it to the "Rules" below the "If program started" block.<br><br> Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>Now drag the "I arrived at the porch" piece from the "Events" tab and attach it next to if. Then, click on the "States" tab and drag "there is coffee in the room" and attach it next to <b>and</b>. This block would help the robot check if there is a coffee in the playroom as soon as it arrives in the room. This check is necessary, since we want the robot to take the coffee to the kitchen before taking the mail. Once the robot arrives at the porch and there is coffee in the room, the robot will now need to pick up the coffee. For that, drag the "pick up any item" piece from actions and attach it next to <b>then</b>. Then change the object to be picked up to <b>coffee</b> by clicking on the caret (downward pointing triangle) of the piece you just attached.<br><br> Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>Now that you have enabled the robot to pick up the coffee at the porch, you’ll need to program the robot to go to the kitchen after having picked up the coffee. To do this, we’ll rely on the event “I picked up an item” to instruct the robot to then head to the kitchen. To do this, click on the "Controls" tab and drag the "if then" piece and attach it to the "Rules" below the last two blocks. Then, from the "Events" tab drag "I picked up an item" and attach it to the new "if then" piece. This piece helps the robot detect if it just picked up something. <br><br> Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>Click on the "Actions" tab and drag the "go to the kitchen" piece inside the newly added "if then" block. This will allow the robot to move to the kitchen once it has picked up the coffee. <br><br> Click <b>Next</b> to proceed. </div>',
        '<div style=\'width:180%\'>Next you will need to program the robot to put down the coffee as soon as it gets to the kitchen. To do that, drag the "if and then" block and attach it below the last block. Then you should add a way to detect if the robot arrives at the kitchen: "I have arrived at the kitchen." Add the piece "put down the item" as an action. <br><br> Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>Once the coffee is brought to the kitchen, the next part of the task is bringing the mail to the kitchen. To do this, click on the "Controls" tab and drag the "if then" piece and attach it to the "Rules" below the previous blocks. Then the event that was just triggered is associated with dropping the coffee specifically “I put down the coffee”. Drag this block from the events tab and attach it to the new rule. Then attach the “go to porch block” action. <br><br> Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>Once the robot is on the porch, it needs to pick up the mail. For that, drag a new <b>"if and then"</b> block and attach it below the last rule block. Then drag the "I arrived at the porch" piece from the "Events" tab and attach it next to if. Then, click on the "States" tab and drag "there is <b>no coffee</b> in the room" and attach it next to <b>and</b>. The check “there is <b>no coffee</b> in the room” is important because the first item the robot needs to move is the coffee. The robot should move the mail only when there is no coffee on the porch. From the action tab drag the “pick up the <b>mail</b>” action and attach it to the newly added rule. Note that this rule is very similar to one you created earlier, differing only in the “and” section. <br><br> Click <b>Next</b> to proceed.</div>',
        "<div style='width:180%'>You've already set a rule for the robot to go to the kitchen when it picks up something, so there's no need for a second rule. Similarly, you have set a rule for the robot's to drop what it is holding as soon as it arrives in the kitchen. Hence, there is no need to introduce another rule for the robot's behavior upon arrival in the kitchen. <br><br> Click <b>Next</b> to proceed.</div>",
        'If your program looks like the image on the right, then press the "Run Program" button to see your program running. Otherwise, move the blocks around to make them match the image and then run the program. <br><br>If the robot remains inactive after you click "Run Program," double check that your program is correct. Click "Stop Program" to make any needed changes and then rerun the program.<br> <br>Click <b>Next</b> to proceed.',
      ];

      var tutorial_texts_RL = [
        "<div style='width:180%'>The robot is designed to act based on <b>GOALS</b>  that you specify. Goals are certain states or combinations of states that we desire the robot to reach or achieve to complete its mission (for example, a toy is in the playroom, the robot is in the kitchen) with specific levels of priorities. <br> In addition to the goals, the robot requires you to specify all of the <b>ACTIONS</b> it might need to complete the task (for example, pick up a toy, move to the kitchen). <br><br> Click <b>Next</b> to proceed.",
        "<div style='width:180%'>Finally, the robot must be informed of the set of distinct <b>STATES</b>. States are the different conditions that a robot may need to evaluate when choosing between different actions. For example, to know whether or not to pick up a toy (action), the robot needs to know whether it is already holding a toy (state). You will need to give the robot a comprehensive list of all of the states the robot needs to consider in learning how to achieve the goal. This list will include states that are directly relevant to the GOAL, as well as intermediate states needed to reach the goal. If a key state is missing, the robot won’t be able to tell when to take an action that is needed to achieve the goal.\
          <br>Once these are provided to it, the robot tries to find the most effective way to accomplish the task and then executes the determined course of action.<br><br> Click <b>Next</b> to proceed.</div>",
        "Now, you will construct a program to make the robot take a toy from the kitchen to the playroom. At the start the robot might be in any one of the four rooms. <br><br> Click <b>Next</b> to proceed.</div>",
        '<div style=\'width:180%\'>To successfully perform this task, the robot needs a specification of the goals. The robot can only know it has achieved its goals by sensing the environment. For the current task, the goal can be stated as the robot seeing the toy in the playroom, which is how the robot would recognize that it has completed the task. Drag the "and" piece from the Goal tab and attach it to the "Goals" piece. Then drag the "I am in the kitchen" piece from the Goal tab and attach it to one of the empty spaces in "and". Then change <b>kitchen</b> to <b>playroom</b> by clicking on the caret (downward pointing triangle) of the piece you just added. Finally, drag the "a toy is in the room" piece and attach it to the remaining space of the "and" piece.<br><br> Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>To successfully perform the task, the robot needs to have a set of actions to try: going to the kitchen, going to the playroom, picking up the toy, and putting down the toy. These are the full set of actions the robot needs to perform to pick up the toy from the playroom and put it down in the kitchen. Note that the robot will figure out the order in which to execute these actions to achieve this goal as long as you provide a complete list. Drag the "go to kitchen" from the "Actions" tab and attach it to the "Actions" block. In addition, add the pieces "go to playroom", "pick up the toy", and "put down the toy" to the "Actions" block. <br>Note that "go to playroom" comes the same base piece as "go to kitchen" (click on the caret to change the room name).<br><br> Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>Now the robot needs to know what states it will need to consider when learning which of these actions to take, in which order, to reach the goal. To correctly choose its actions, the robot needs to check the states of being in the kitchen, being in the playroom, seeing a toy in a room, and holding the toy. These are the relevant set of states the robot needs for choosing actions for reaching the goal. Drag the pieces that represent each state ("Am I in the kitchen?", "Am I in the playroom?", "Are my hands empty?", and "Is there a toy in the current room") from the "States" tab and attach them to the "States" block. <br>Again, you need to use the caret to change the room name. <br><br> Click <b>Next</b> to proceed.</div>',
        'If your program looks like the image on the right, then press the "Run Program" button to see your program running. Otherwise, move the blocks around to make them match the image and then run the program. <br><br> Note that the order of the pieces in the "States" and "Actions" blocks do not matter. <br><br> Click <b>Next</b> to proceed.',
        "<div style='width:180%'>Now you will work on the final task. In this task, both coffee and mail will start on the porch, and your objective is to program a robot to move the coffee and mail from the porch to the kitchen. However, because the coffee is likely to get cold if outside too long, the robot should first move the coffee to the kitchen and then come back to move the mail to the kitchen. The robot should take the coffee to the kitchen and then the mail to the kitchen in this order. <br><br>Click <b>Next</b> to proceed.</div>",
        "<div style='width:180%'>First, remove all of the pieces added to the programming interface by dragging each one to the trash bin.  <br><br> Click <b>Next</b> to proceed.</div>",
        "<div style='width:180%'>To have the robot perform the task,  You need to specify two goals — the first is moving the coffee from the porch to the kitchen, and the second is moving the mail from the porch. To make sure the first goal is satisfied before the second, we will attach the first goal to the high priority slot in the “Goals” piece, and the second goal to the medium priority slot. <br><br> Again, because the goal is sensed from the robot’s perspective, we need the robot to be in the room when the goal is satisfied. <br><br>Click <b>Next</b> to proceed.</div>",
        '<div style=\'width:180%\'>For the first goal, drag the "and" piece from the Goal tab and attach it to the slot for high priority in the "Goals" piece. Then, click on the Goal tab again, locate the "I am in the kitchen" piece, and drag it to connect it to one of the empty spaces in the "and" piece. Finally, add the piece "there is a toy in the room" and attach it to the remaining space of the "and" piece.  Then change <b>toy</b> to <b>coffee</b> by clicking on the caret (downward pointing triangle) of the piece you just added. <br><br>Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>For the second goal, drag the "and" piece from the Goal tab and attach it to the slot for medium priority in the "Goals" piece. Then, click on the Goal tab again, locate the "I am in the kitchen" piece, and drag it to connect it to one of the empty spaces in the "and" piece. Finally, add the piece "there is a toy in the room" and attach it to the remaining space of the "and" piece.  Then change <b>toy</b> to <b>mail</b> by clicking on the caret (downward pointing triangle) of the piece you just added. <br><br> Note that the "there is a coffee in the room" piece is the same as the "there is mail in the room" (click on the caret to change the room name). <br><br>Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'> To successfully perform the task, the robot needs to try a set of actions: going to the kitchen, going to the porch, picking up the coffee, picking up the mail, putting down the coffee, and putting down the mail. Drag the "go to kitchen" piece from the "Actions" tab and attach it to the "Actions" block. In addition, also add the pieces "go to porch", "pick up the coffee", “pick up the mail”, and "put down the coffee", and “put down the mail” to the "Actions" block. <br><br>Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>Now the robot needs to know what states it will need to check when deciding which of these actions to take to reach the goal. To correctly choose its actions, the robot needs to check the states of being in the kitchen, being on the porch, seeing a coffee, holding the coffee, seeing the mail, and holding the mail. These are the relevant set of states the robot needs for choosing which actions to take, and in which order, for achieving its goals. Drag the pieces that represent each state ("Am I in the kitchen?", "Am I in the porch?", "Are my hands empty?", "Is there coffee in the current room?", and “Is there mail in the current room?”) from the "States" tab and attach them to the "States" block. <br><br>Click <b>Next</b> to proceed.</div>',
        'If your program looks like the image on the right, then press the "Run Program" button to see your program running. Otherwise, move the blocks around to make them match the image and then run the program. <br><br>Note that the order of the pieces in the "States" and "Actions" blocks do not matter. <br><br>Click <b>Next</b> to proceed.',
      ];

      var tutorial_texts_MDP = [
        "<div style='width:180%'>The robot is designed to act based on a GOAL that you specify. Goals are certain states or combinations of states that we desire the robot to reach or achieve to complete its mission (for example, a toy is in the playroom, the robot is in the kitchen). <br><br> The robot will try to find the most effective way to accomplish the goal you specify and then executes that course of action. <br><br> Click <b>Next</b> to proceed. </div>",
        "<div style='width:180%'> Now, you will construct a program to make the robot take a toy from the kitchen to the playroom. At the start the robot might be in any one of the four rooms. <br><br> Click <b>Next</b> to proceed. </div>",
        '<div style=\'width:180%\'>To successfully perform this task, the robot needs a specification of the goals. The robot can only know it has achieved its goals by sensing the environment. For the current task, the goal can be stated as the robot seeing the toy in the playroom, which is how the robot would recognize that it has completed the task. Drag the "and" piece from the "Goal" tab and attach it to the "Goal" piece. Then drag "I am in the kitchen" piece from the Goal tab and attach it to one of the empty spaces in "and". Then change <b>kitchen</b> to <b>playroom</b> by clicking on the caret (downward pointing triangle) of the piece you just added. Finally, drag "a toy is in the room" piece and attach it to the remaining space of the "and" piece. <br><br> Click <b>Next</b> to proceed. </div>',
        'If your program looks like the image on the right, then press the "Run Program" button to see your program running. <br><br>Otherwise, move the blocks around to make them match the image and then run the program. <br><br> Click <b>Next</b> to proceed. ',
        "<div style='width:180%'> Now you will work on the final task. In this task, both coffee and mail will start on the porch, and your objective is to program a robot to move the coffee and mail from the porch to the kitchen. However, because the coffee is likely to get cold if outside too long, the robot should first move the coffee to the kitchen and then come back to move the mail to the kitchen. The robot should take the coffee to the kitchen and then the mail to the kitchen in this order.  <br><br> Click <b>Next</b> to proceed. </div>",
        "<div style='width:180%'>First, remove all of the pieces added to the programming interface by dragging each one to the trash bin.  <br><br> Click <b>Next</b> to proceed.</div>",
        "<div style='width:180%'>To do this, you need to specify two goals — the first is moving the coffee from the porch to the kitchen, and the second is moving the mail from the porch. To make sure the first goal is satisfied before the second, we will attach the first goal to the high priority slot in the “Goals” piece, and the second goal to the medium priority slot. Again, because the goal is sensed from the robot’s perspective, we need the robot to be in the room when the goal is satisfied. <br><br>Click <b>Next</b> to proceed.</div>",
        '<div style=\'width:180%\'>For the first goal, drag the "and" piece from the Goal tab and attach it to the slot for high priority in the "Goals" piece. Then, click on the Goal tab again, locate the "I am in the kitchen" piece, and drag it to connect it to one of the empty spaces in the "and" piece. Finally, add the piece "there is a toy in the room" and attach it to the remaining space of the "and" piece.  Then change <b>toy</b> to <b>coffee</b> by clicking on the caret (downward pointing triangle) of the piece you just added. <br><br>Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>For the second goal, drag the "and" piece from the Goal tab and attach it to the slot for medium priority in the "Goals" piece. Then, click on the Goal tab again, locate the "I am in the kitchen" piece, and drag it to connect it to one of the empty spaces in the "and" piece. Finally, add the piece "there is a toy in the room" and attach it to the remaining space of the "and" piece.  Then change <b>toy</b> to <b>mail</b> by clicking on the caret (downward pointing triangle) of the piece you just added. <br><br> Note that the "there is a coffee in the room" piece is the same as the "there is mail in the room" (click on the caret to change the room name). <br><br>Click <b>Next</b> to proceed.</div>',
        'If your program looks like the image on the right, then press the "Run Program" button to see your program running. Otherwise, move the blocks around to make them match the image and then run the program. <br><br>Click <b>Next</b> to proceed.',
      ];

      var tutorial_texts_SEQ = [
        "<div style='width:180%'>The robot requires you to specify the sequence of <b>ACTIONS</b> it needs to complete the task (for example, pick up a toy, move to the kitchen). The robot executes these sequences of actions one after the other towards completing its mission. <br><br>Optionally, you may specify <b>STATES</b> or conditions that a robot may need to evaluate before executing an action. For example, before trying to pick up a toy (action), the robot could first assess whether it is already holding a toy (state). <br><br> Click <b>Next</b> to proceed.</div>",
        '<div style=\'width:180%\'> Now, you will construct a program to make the robot take a toy from the kitchen to the playroom. At the start the robot might be in any one of the four rooms. Therefore, we start by adding an action to move the robot to the kitchen. To achieve this, Click on the "Actions" tab and drag the "go to kitchen" piece and attach it to the “when the program starts” block on the programming interface. This action will make the robot move to the kitchen. <br> <br> Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>Once the robot arrives in the kitchen, it needs to pick up the toy. Before trying to pick up the toy, you will program the robot to check if there is a toy. This check may seem unnecessary for this task since we know that the toy will be in the kitchen. However, in other situations, the robot may not know where the toy is ahead of time, which makes performing this check to see if the toy is in the room helpful. To check if a toy is present in the room, click on the "Controls" tab and drag the "If do" block and attach it under the "Go to kitchen" piece. <br> Then, drag "a toy is in the room" piece from the "States" tab and attach it to the if.<br> <br> Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>Click on the "Actions" tab and drag the "Pick up the toy" piece and attach it next to do. This block instructs the robot to pick up the toy only if it detects there is a toy in the room. <br><br> Once the robot picks up the toy, its next step is to take the toy to the kitchen. Drag the "Go to playroom" piece and attach it below the "if do" block. <br><br>Click <b>Next</b> to proceed</div>',
        '<div style=\'width:180%\'>The final step is to put down the toy once the robot reaches the kitchen. Click on the "Actions" menu and drag the "put down the item" piece below the last piece.  Optionally, you can change "put down the item" to "put down the toy" (click on the caret to change the item name). This will also instruct the robot to put down the toy. <br><br> Note that the action "put down the item" directs the robot to put down whatever object it is currently holding. However, the action "put down the toy" specifically instructs the robot to put down the toy. If the robot is holding an item other than a toy, the instruction "put down the toy" would not prompt the robot to release the held object.  <br><br>Click <b>Next</b> to proceed</div>',
        'If your program looks like the image on the right, then press the "Run Program" button to see your program running. <br><br> Otherwise, move the blocks around to make them match the image and then run the program. <br><br>If the robot remains inactive after you click "Run Program," double check that your program is correct. Click "Stop Program" to make any needed changes and then rerun the program.<br> <br> Click <b>Next</b> to proceed.',
        "Now you will work on a second task. Your task is to program the robot to go back and forth between the kitchen and the playroom forever. If you create a program like the one on the right, the robot will initially go to the playroom, then to the kitchen, then back to the playroom. After this third action, the robot will come to a stop in the kitchen and remain there. <br><br> Click <b>Next</b> to proceed.",
        '<div style=\'width:180%\'>However, this task requires you to program the robot to move forever. While it is possible to include additional "Go to kitchen" and "Go to playroom" pieces, they will only contribute to one additional loop through the movements. <br><br> Note that the "go to playroom" piece is the same as the "go to kitchen" piece (click on the caret to change the room name). <br><br> Click <b>Next</b> to proceed.</div>',
        "<div style='width:180%'>To program the robot to move iteratively, first remove all the pieces you added to the programming interface by dragging each of them to the trash bin found on the bottom right corner. <br><br>  Click <b>Next</b> to proceed.</div>",
        '<div style=\'width:180%\'>Then click on the "Control" tab and drag the piece labeled "repeat while do" and drop it on the programming interface. Next from the "Control" tab drag the piece labeled "True" and attach it right next to <b>while</b>. The "repeat while do" block runs all the pieces inside it as long as the condition you attach next to while is true. Attaching <b>True</b> next to while means the block will be executed forever.<br><br> Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>Next you need to put the actions that the robot needs to repeat inside the "repeat while do" block. For this task, the robot needs to move to the kitchen. Click on "Actions" tab and drag the "Go to kitchen" piece and attach it inside the "repeat while do" block. <br><br> Again, go to the "Actions" tab and drag "go to kitchen" piece inside the "repeat while do" block right below the previous piece. Now, change <b>kitchen</b> to <b>playroom</b> by clicking on the caret (downward pointing triangle) of the piece. This block makes sure the robot goes to the kitchen, then to the playroom, repeating forever. <br><br>Click <b>Next</b> to proceed.</div>',
        'If your program looks like the image on the right, then press the "Run Program" button to see your program running. <br><br> Otherwise, move the blocks around to make them match the image and then run the program.<br><br> Click <b>Next</b> to proceed',
        "<div style='width:180%'>Now you will work on the final task. In this task, both a cup of coffee and a piece of mail will start on the porch, and your objective is to program a robot to move the coffee and mail from the porch to the kitchen. However, because the coffee is likely to get cold if outside too long, the robot should first move the coffee to the kitchen and then come back to move the mail to the kitchen. The robot should take the coffee to the kitchen and then the mail to the kitchen in this order. <br><br>Click <b>Next</b> to proceed.</div>",
        "<div style='width:180%'>First, remove all of the pieces added to the programming interface by dragging each one to the trash bin.  <br><br> Click <b>Next</b> to proceed.</div>",
        '<div style=\'width:180%\'>To have the robot perform the task, you’ll first need the robot to go to the porch. Click on the "Actions" tab and attach the "Go to kitchen" piece to “when the program starts” block. Then change <b>kitchen</b> to <b>porch</b>. <br><br> Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>Once the robot arrives on the porch, it needs to pick up the coffee. Click on the "Actions" tab and drag the "Pick up any item" piece and attach it right below the previous piece. Then change the object to be picked up to <b>coffee</b> by clicking on the caret (downward pointing triangle) of the piece you just attached. This block instructs the robot to pick up the coffee. <br><br> Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>Once the robot picks up the coffee, its next step is to take the coffee to the kitchen. Drag the "Go to kitchen" piece and attach it below the "Pick up the coffee” piece <br><br> Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>The next step is to put down the coffee once the robot reaches the kitchen. Click on the "Actions" menu and drag the "put down the item" piece below the last piece. Again, you can change "the item" to "the coffee" to put down the coffee. <br><br> Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>Once the coffee is brought to the kitchen, the next part of the task is bringing the mail to the kitchen.  Click on the "Actions" tab and attach the "Go to kitchen" piece to the previously added piece and change kitchen to porch. <br><br> Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>Once the robot arrives on the porch, it needs to pick up the mail. Click on the "Actions" tab and drag the "Pick up any item" piece and attach it right below the previous piece. Then change the object to be picked up to <b>mail</b> from the options on the piece you just attached. This block instructs the robot to pick up the mail. <br><br> Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>Once the robot picks up the mail, its next step is to take the mail to the kitchen. Drag the "Go to kitchen" piece and attach it below the "Pick up the mail” block <br><br> Click <b>Next</b> to proceed.</div>',
        '<div style=\'width:180%\'>The final step is to put down the mail once the robot reaches the kitchen. Click on the "Actions" menu and drag the "put down the item" piece below the last piece.</div>',
        'If your program looks like the image on the right, then press the "Run Program" button to see your program running. <br><br> Click <b>Next</b> to proceed.',
      ];

      function nextTutorialListener(n) {
        document.querySelector("#doneButton").addEventListener("click", () => {
          document.getElementById("modal").style.display = "block";
        });

        if (value == "TAP") {
          final_cnt = tutorial_texts.length;
        } else if (value == "SEQ") {
          final_cnt = tutorial_texts_SEQ.length;
        } else {
          final_cnt = tutorial_texts_RL.length;
        }

        if ((Number(n) == 1) & (next_ctr > 0)) {
          next_ctr -= 1;
        } else if ((Number(n) == 1) & (next_ctr <= 0)) {
          next_ctr = next_ctr;
        } else if ((Number(n) == 0) & (next_ctr <= final_cnt + 1)) {
          next_ctr += 1;
        }

        if (img_added) {
          document.getElementById("img_div").innerHTML = "";
          img_added = false;
        }

        if (value == "TAP") {
          if (next_ctr <= 13) {
            document.getElementById("bear").style.visibility = "visible";
            document.getElementById("coffee").style.visibility = "hidden";
            document.getElementById("mail").style.visibility = "hidden";
          } else {
            document.getElementById("bear").style.visibility = "hidden";
            document.getElementById("coffee").style.visibility = "visible";
            document.getElementById("mail").style.visibility = "visible";
          }

          document.getElementById("tutorial_text").innerHTML =
            tutorial_texts[next_ctr];

          if (next_ctr == 13) {
            var elem = document.createElement("img");
            elem.src = "tutorial/sol_01.png";
            document.getElementById("img_div").appendChild(elem);
            img_added = true;
          } else if (next_ctr == 9) {
            document.getElementById("img_div").innerHTML = "";
          } else if (next_ctr == 26) {
            var elem = document.createElement("img");
            elem.src = "tutorial/sol_02.png";
            document.getElementById("img_div").appendChild(elem);
            img_added = true;
          }

          if (next_ctr >= tutorial_texts.length) {
            document.getElementById("img_div").innerHTML = "";
            document.getElementById("doneButton").style.visibility = "visible";
            document.getElementById("tutorial_text").innerHTML =
              "Congratulations on completing the tutorial! Now click on the <b>I'm done</b> button.";
          } else {
            document.getElementById("doneButton").style.visibility = "hidden";
          }
        } else if (value == "FULL_MDP") {
          if (next_ctr <= 8) {
            document.getElementById("bear").style.visibility = "visible";
            document.getElementById("coffee").style.visibility = "hidden";
            document.getElementById("mail").style.visibility = "hidden";
          } else {
            document.getElementById("bear").style.visibility = "hidden";
            document.getElementById("coffee").style.visibility = "visible";
            document.getElementById("mail").style.visibility = "visible";
          }

          if (next_ctr < 2) {
            document.getElementById("tutorial_text").innerHTML =
              tutorial_texts[next_ctr];
            document.getElementById("img_div").innerHTML = "";
          } else {
            document.getElementById("tutorial_text").innerHTML =
              tutorial_texts_RL[next_ctr - 2];
          }
          if (next_ctr == 8) {
            var elem = document.createElement("img");
            elem.src = "tutorial/sol_05.png";
            document.getElementById("img_div").appendChild(elem);
            img_added = true;
          } else if (next_ctr == 9) {
            document.getElementById("img_div").innerHTML = "";
          } else if (next_ctr == 16) {
            var elem = document.createElement("img");
            elem.src = "tutorial/sol_06.png";
            document.getElementById("img_div").appendChild(elem);
            img_added = true;
          }

          if (next_ctr - 2 >= tutorial_texts_RL.length) {
            document.getElementById("img_div").innerHTML = "";
            document.getElementById("doneButton").style.visibility = "visible";
            document.getElementById("tutorial_text").innerHTML =
              "Congratulations on completing the tutorial! Now click on the <b>I'm done</b> button.";
          } else {
            document.getElementById("doneButton").style.visibility = "hidden";
          }
        } else if (value == "GOAL_MDP") {
          if (next_ctr <= 5) {
            document.getElementById("bear").style.visibility = "visible";
            document.getElementById("coffee").style.visibility = "hidden";
            document.getElementById("mail").style.visibility = "hidden";
          } else {
            document.getElementById("bear").style.visibility = "hidden";
            document.getElementById("coffee").style.visibility = "visible";
            document.getElementById("mail").style.visibility = "visible";
          }

          if (next_ctr < 2) {
            document.getElementById("tutorial_text").innerHTML =
              tutorial_texts[next_ctr];
          } else {
            document.getElementById("tutorial_text").innerHTML =
              tutorial_texts_MDP[next_ctr - 2];
          }
          if (next_ctr == 5) {
            var elem = document.createElement("img");
            elem.src = "tutorial/sol_07.png";
            document.getElementById("img_div").appendChild(elem);
            img_added = true;
          } else if (next_ctr == 6) {
            document.getElementById("img_div").innerHTML = "";
          } else if (next_ctr == 11) {
            var elem = document.createElement("img");
            elem.src = "tutorial/sol_08.png";
            document.getElementById("img_div").appendChild(elem);
            img_added = true;
          }

          if (next_ctr - 2 >= tutorial_texts_MDP.length) {
            document.getElementById("img_div").innerHTML = "";
            document.getElementById("doneButton").style.visibility = "visible";
            document.getElementById("tutorial_text").innerHTML =
              "Congratulations on completing the tutorial! Now click on the <b>I'm done</b> button.";
          } else {
            document.getElementById("doneButton").style.visibility = "hidden";
          }
        } else if (value == "SEQ") {
          if (next_ctr <= 8) {
            document.getElementById("bear").style.visibility = "visible";
            document.getElementById("coffee").style.visibility = "hidden";
            document.getElementById("mail").style.visibility = "hidden";
          } else if ((8 < next_ctr) & (next_ctr <= 13)) {
            document.getElementById("bear").style.visibility = "hidden";
            document.getElementById("coffee").style.visibility = "hidden";
            document.getElementById("mail").style.visibility = "hidden";
          } else {
            document.getElementById("bear").style.visibility = "hidden";
            document.getElementById("coffee").style.visibility = "visible";
            document.getElementById("mail").style.visibility = "visible";
          }

          if (next_ctr < 2) {
            document.getElementById("tutorial_text").innerHTML =
              tutorial_texts[next_ctr];
          } else {
            document.getElementById("tutorial_text").innerHTML =
              tutorial_texts_SEQ[next_ctr - 2];
          }

          if (next_ctr == 7) {
            document.getElementById("one_time_div").innerHTML = "";
            var elem = document.createElement("img");
            elem.src = "tutorial/sol_03.png";
            elem.style = "margin-top: 5%;";
            document.getElementById("img_div").appendChild(elem);
            img_added = true;
          } else if (next_ctr == 8) {
            document.getElementById("one_time_div").innerHTML = "";
            var elem = document.createElement("img");
            elem.src = "tutorial/extra_tutorial_00.png";
            document.getElementById("one_time_div").appendChild(elem);
            img_added = true;
          } else if (next_ctr == 9) {
            document.getElementById("img_div").innerHTML = "";
            document.getElementById("one_time_div").innerHTML = "";
          } else if (next_ctr == 13) {
            var elem = document.createElement("img");
            elem.src = "tutorial/extra_seq_sol.png";
            document.getElementById("img_div").appendChild(elem);
            img_added = true;
          } else if (next_ctr == 14) {
            document.getElementById("img_div").innerHTML = "";
          } else if (next_ctr == 24) {
            var elem = document.createElement("img");
            elem.src = "tutorial/sol_04.png";
            document.getElementById("img_div").appendChild(elem);
            img_added = true;
          }

          if (next_ctr - 2 >= tutorial_texts_SEQ.length) {
            document.getElementById("img_div").innerHTML = "";
            document.getElementById("doneButton").style.visibility = "visible";
            document.getElementById("tutorial_text").innerHTML =
              "Congratulations on completing the tutorial! Now click on the <b>I'm done</b> button.";
          } else {
            document.getElementById("doneButton").style.visibility = "hidden";
          }
        }
      }
    </script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.8.2/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.8.2/firebase-analytics.js";
      import {
        getFirestore,
        collection,
        addDoc,
      } from "https://www.gstatic.com/firebasejs/9.8.2/firebase-firestore.js";

      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyB5uekkMlVNEhKwg_4BBPKb6lPFuYo5ctw",
        authDomain: "final-2-3c725.firebaseapp.com",
        projectId: "final-2-3c725",
        storageBucket: "final-2-3c725.appspot.com",
        messagingSenderId: "906897795091",
        appId: "1:906897795091:web:e9330f879fe6fc9445f7e6",
        measurementId: "G-Z57QHX4BVY",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);

      // Initialize Cloud Firestore and get a reference to the service
      const db = getFirestore(app);

      console.log(window.location.href);
      const url = new URL(window.location.href);
      const study_id = url.searchParams.get("STUDY_ID");
      const prolific_pid = url.searchParams.get("PROLIFIC_PID");
      const session_id = url.searchParams.get("SESSION_ID");
      const format = url.searchParams.get("format");

      let round = 1;
      let operationOrder = 1;

      document.querySelector("#runButton").addEventListener("click", () => {
        console.log(document.getElementById("runButton").innerHTML);
        if (document.getElementById("runButton").innerHTML != "Stop Program") {
          console.log("recording");
          record("stopped");
          round += 1;
          operationOrder = 0;
        } else {
          record("started");
        }
      });

      document.querySelector("#doneButton").addEventListener("click", () => {
        record("final");
        document.getElementById("modal").style.display = "block";
      });

      async function onChange(event) {
        if (event.type == Blockly.Events.BLOCK_CHANGE && event.name) {
          const eventJson = event.toJson();
          const block = workspace.getBlockById(eventJson.blockId);
          try {
            const timeElapsed = Date.now();
            const today = new Date(timeElapsed);
            const docRef = await addDoc(
              collection(
                db,
                `${format}/${study_id}_${prolific_pid}_${session_id}/tutorial/round${round}/changed/`
              ),
              {
                timestamp: today.toISOString(),
                code: Blockly.JavaScript.workspaceToCode(workspace),
                change: eventJson.type,
                block: block.type,
                newValue: eventJson.newValue,
                oldValue: eventJson.oldValue,
                order: operationOrder,
              }
            );
            operationOrder += 1;
            console.log("Document written with ID: ", docRef.id);
          } catch (e) {
            console.error("Error adding document: ", e);
          }
        }
      }

      async function onDelete(event) {
        if (event.type == Blockly.Events.BLOCK_DELETE) {
          const eventJson = event.toJson();
          console.log(event.toJson());

          try {
            const timeElapsed = Date.now();
            const today = new Date(timeElapsed);
            // console.log(`${study_id}/${prolific_pid}/${session_id}/task1/${format}/added`)
            const docRef = await addDoc(
              collection(
                db,
                `${format}/${study_id}_${prolific_pid}_${session_id}/tutorial/round${round}/deleted/`
              ),
              {
                timestamp: today.toISOString(),
                code: Blockly.JavaScript.workspaceToCode(workspace),
                change: eventJson.type,
                block: eventJson.oldJson,
                order: operationOrder,
              }
            );
            operationOrder += 1;
            console.log("Document written with ID: ", docRef.id);
          } catch (e) {
            console.error("Error adding document: ", e);
          }
        }
      }

      async function onBlockCreate(event) {
        if (event.type == Blockly.Events.BLOCK_CREATE) {
          const eventJson = event.toJson();
          console.log(event.toJson());
          try {
            const timeElapsed = Date.now();
            const today = new Date(timeElapsed);
            // console.log(`${study_id}/${prolific_pid}/${session_id}/task1/${format}/added`)
            const docRef = await addDoc(
              collection(
                db,
                `${format}/${study_id}_${prolific_pid}_${session_id}/tutorial/round${round}/created/`
              ),
              {
                timestamp: today.toISOString(),
                code: Blockly.JavaScript.workspaceToCode(workspace),
                change: eventJson.type,
                block: eventJson.json.type,
                order: operationOrder,
              }
            );
            operationOrder += 1;
            console.log("Document written with ID: ", docRef.id);
          } catch (e) {
            console.error("Error adding document: ", e);
          }
        }
      }

      async function onMove(event) {
        if (event.type == Blockly.Events.BLOCK_MOVE) {
          // alert("Congratulations on creating your first comment!");
          console.log(event.toJson());
          const eventJson = event.toJson();
          const block = workspace.getBlockById(eventJson.blockId);
          let newParent = "";
          let oldParent = "";
          if (eventJson.newParentId) {
            newParent = workspace.getBlockById(eventJson.newParentId).type;
          }
          if (eventJson.oldParentId) {
            oldParent = workspace.getBlockById(eventJson.newParentId).type;
          }
          try {
            const timeElapsed = Date.now();
            const today = new Date(timeElapsed);
            const docRef = await addDoc(
              collection(
                db,
                `${format}/${study_id}_${prolific_pid}_${session_id}/tutorial/round${round}/moved/`
              ),
              {
                timestamp: today.toISOString(),
                code: Blockly.JavaScript.workspaceToCode(workspace),
                change: eventJson.type,
                block: block.type,
                newConnection: newParent,
                oldConnection: oldParent,
                order: operationOrder,
              }
            );
            operationOrder += 1;
            console.log("Document written with ID: ", docRef.id);
            // console.log(Blockly.JavaScript.workspaceToCode(workspace));
          } catch (e) {
            console.error("Error adding document: ", e);
          }
        }
      }

      workspace.addChangeListener(onChange);
      workspace.addChangeListener(onDelete);
      workspace.addChangeListener(onBlockCreate);
      workspace.addChangeListener(onMove);

      async function record(runStatus) {
        console.log("end", document.getElementById("end").innerHTML);
        console.log("start", document.getElementById("start").innerHTML);
        try {
          const timeElapsed = Date.now();
          const today = new Date(timeElapsed);
          const docRef = await addDoc(
            collection(
              db,
              `${format}/${study_id}_${prolific_pid}_${session_id}/tutorial/round${round}/${runStatus}/`
            ),
            {
              timestamp: today.toISOString(),
              code: Blockly.JavaScript.workspaceToCode(workspace),
              start_state: document.getElementById("start").innerHTML,
              end_state: document.getElementById("end").innerHTML,
              runStatus: runStatus,
              order: operationOrder,
            }
          );
          operationOrder += 1;
          console.log("Document written with ID: ", docRef.id);
        } catch (e) {
          console.error("Error adding document: ", e);
        }
      }
    </script>
  </body>
</html>
